name: Deploy to LINE Notify and Update Record

on:
  schedule:
    - cron: '0 12 * * 3,6,0' # UTC時間12:00，對應東八區20:00，每週三、六、日執行
  workflow_dispatch:  # 允許手動觸發

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Use Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'  # 或者你需要的 Node.js 版本
    
    - name: Install dependencies
      run: npm install
    
    - name: Run crawler
      run: |
        output=$(node crawler.js)
        echo "$output"
        unique_data=$(echo "$output" | grep "UNIQUE_DATA:" | sed 's/UNIQUE_DATA://g')
        echo "unique_data=$unique_data" >> $GITHUB_OUTPUT

    - name: Send LINE Notify
      # if: steps.crawler.outputs.unique_data != '[]'
        #       -F "stickerPackageId=446" \
        # -F "stickerId=1993"
      env:
        LINE_NOTIFY_TOKEN: ${{ secrets.LINE_NOTIFY_TOKEN2 }}
      run: |
        unique_data='${{ steps.crawler.outputs.unique_data }}'
        # 移除開頭和結尾的方括號，然後用換行符替換逗號和引號
        message=$(echo $unique_data | sed 's/^\[//;s/\]$//;s/","/\n/g;s/"//g')
        echo "$unique_data"
        echo "$message"
        curl -X POST https://notify-api.line.me/api/notify \
        -H "Authorization: Bearer $LINE_NOTIFY_TOKEN" \
        -F "message=hello world" \


    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add record.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update record.json on $(date +'%Y-%m-%d %H:%M:%S %Z')" && git push)